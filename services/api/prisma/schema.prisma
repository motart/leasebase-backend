generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrganizationType {
  LANDLORD
  PM_COMPANY
}

enum UserRole {
  ORG_ADMIN
  PM_STAFF
  OWNER
  TENANT
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  TERMINATED
  EXPIRED
}

enum LedgerEntryType {
  CHARGE
  PAYMENT
  CREDIT
}

enum LedgerEntryStatus {
  PENDING
  POSTED
  VOID
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

model Organization {
  id                   String             @id @default(cuid())
  type                 OrganizationType
  name                 String
  plan                 String             @default("basic")
  subdomain            String?            @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  unitCount            Int                @default(0)

  users                User[]
  properties           Property[]
  units                Unit[]
  leases               Lease[]
  ledgerEntries        LedgerEntry[]
  payments             Payment[]
  workOrders           WorkOrder[]
  documents            Document[]
  auditLogs            AuditLog[]
  subscription         Subscription?

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}

model User {
  id                 String             @id @default(cuid())
  organizationId     String
  organization       Organization       @relation(fields: [organizationId], references: [id])

  email              String
  name               String
  cognitoSub         String?            @unique
  role               UserRole
  status             String             @default("ACTIVE")

  tenantProfile      TenantProfile?
  workOrdersAssigned WorkOrder[]        @relation("WorkOrderAssignee")
  workOrderComments  WorkOrderComment[] @relation("WorkOrderCommentAuthor")
  auditLogs          AuditLog[]         @relation("AuditActor")

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@unique([organizationId, email])
  @@index([organizationId])
}

model Property {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  name            String
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  country         String        @default("US")
  status          String        @default("ACTIVE")

  units           Unit[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
}

model Unit {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  propertyId      String
  property        Property      @relation(fields: [propertyId], references: [id])

  unitNumber      String
  bedrooms        Int
  bathrooms       Float
  squareFeet      Int?
  rentAmount      Int           // cents
  status          String        @default("AVAILABLE")

  leases          Lease[]
  workOrders      WorkOrder[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([propertyId])
  @@index([organizationId])
}

model Lease {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id])

  startDate       DateTime
  endDate         DateTime
  rentAmount      Int           // cents
  depositAmount   Int?
  status          LeaseStatus   @default(ACTIVE)

  tenants         TenantProfile[]
  ledgerEntries   LedgerEntry[]
  payments        Payment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
  @@index([unitId])
}

model TenantProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  leaseId   String
  lease     Lease    @relation(fields: [leaseId], references: [id])

  phone     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LedgerEntry {
  id              String             @id @default(cuid())
  organizationId  String
  organization    Organization       @relation(fields: [organizationId], references: [id])

  leaseId         String
  lease           Lease              @relation(fields: [leaseId], references: [id])

  type            LedgerEntryType
  amount          Int                // cents
  currency        String             @default("usd")
  dueDate         DateTime
  status          LedgerEntryStatus  @default(PENDING)
  description     String?

  paymentId       String?
  payment         Payment?           @relation(fields: [paymentId], references: [id])

  createdAt       DateTime           @default(now())

  @@index([leaseId])
  @@index([organizationId])
}

model Payment {
  id                     String         @id @default(cuid())
  organizationId         String
  organization           Organization   @relation(fields: [organizationId], references: [id])

  leaseId                String
  lease                  Lease          @relation(fields: [leaseId], references: [id])

  tenantProfileId        String?
  tenantProfile          TenantProfile? @relation(fields: [tenantProfileId], references: [id])

  ledgerEntryId          String?
  ledgerEntry            LedgerEntry?   @relation(fields: [ledgerEntryId], references: [id])

  amount                 Int            // cents
  currency               String         @default("usd")
  method                 String?
  status                 PaymentStatus  @default(PENDING)

  stripePaymentIntentId  String?        @unique

  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  @@index([leaseId])
  @@index([organizationId])
}

model WorkOrder {
  id               String           @id @default(cuid())
  organizationId   String
  organization     Organization     @relation(fields: [organizationId], references: [id])

  unitId           String
  unit             Unit             @relation(fields: [unitId], references: [id])

  createdByUserId  String
  createdByUser    User             @relation(fields: [createdByUserId], references: [id])

  tenantUserId     String?
  tenantUser       User?            @relation("WorkOrderTenantUser", fields: [tenantUserId], references: [id])

  category         String
  priority         WorkOrderPriority @default(MEDIUM)
  status           WorkOrderStatus   @default(OPEN)
  description      String

  comments         WorkOrderComment[]

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([organizationId])
  @@index([unitId])
}

model WorkOrderComment {
  id          String   @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])

  userId      String
  user        User     @relation("WorkOrderCommentAuthor", fields: [userId], references: [id])

  comment     String

  createdAt   DateTime @default(now())
}

model Document {
  id               String        @id @default(cuid())
  organizationId   String
  organization     Organization  @relation(fields: [organizationId], references: [id])

  relatedType      String
  relatedId        String
  name             String
  s3Key            String
  mimeType         String
  createdByUserId  String
  createdByUser    User          @relation(fields: [createdByUserId], references: [id])

  createdAt        DateTime      @default(now())

  @@index([organizationId])
  @@index([organizationId, relatedType, relatedId])
}

model AuditLog {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  userId          String?
  user            User?         @relation("AuditActor", fields: [userId], references: [id])

  action          String
  entityType      String
  entityId        String
  metadataJson    Json?

  createdAt       DateTime      @default(now())

  @@index([organizationId])
  @@index([organizationId, createdAt])
}

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  organization         Organization       @relation(fields: [organizationId], references: [id])

  plan                 String
  unitCount            Int
  stripeSubscriptionId String?
  status               SubscriptionStatus @default(ACTIVE)

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}
