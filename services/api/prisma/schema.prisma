generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                 String        @id @default(cuid())
  name               String
  subdomain          String        @unique
  stripeCustomerId   String?       @unique
  stripeSubscriptionId String?     @unique
  plan               String        @default("basic")
  units              Int           @default(0)
  users              User[]
  properties         Property[]
  leases             Lease[]
  ledgerEntries      LedgerEntry[]
  payments           Payment[]
  workOrders         WorkOrder[]
  documents          Document[]
  auditLogs          AuditLog[]
  subscription       Subscription?

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

enum UserRole {
  OWNER
  PROPERTY_MANAGER
  ACCOUNTANT
  MAINTENANCE
  TENANT
}

model User {
  id              String          @id @default(cuid())
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id])

  email           String
  cognitoSub      String          @unique
  role            UserRole
  firstName       String
  lastName        String

  tenantProfile   TenantProfile?
  workOrders      WorkOrder[]     @relation("WorkOrderAssignee")
  workOrderComments WorkOrderComment[] @relation("WorkOrderCommentAuthor")
  auditLogs       AuditLog[]      @relation("AuditActor")

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([organizationId, email])
}

model Property {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  name            String
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  country         String         @default("US")

  units           Unit[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
}

model Unit {
  id              String       @id @default(cuid())
  propertyId      String
  property        Property     @relation(fields: [propertyId], references: [id])

  unitNumber      String
  bedrooms        Int
  bathrooms       Float
  squareFeet      Int?

  leases          Lease[]
  workOrders      WorkOrder[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([propertyId])
}

model Lease {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  unitId          String
  unit            Unit          @relation(fields: [unitId], references: [id])

  startDate       DateTime
  endDate         DateTime
  rentAmountCents Int
  securityDepositCents Int?
  status          LeaseStatus   @default(ACTIVE)

  tenants         TenantProfile[]
  ledgerEntries   LedgerEntry[]
  payments        Payment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId])
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  TERMINATED
  EXPIRED
}

model TenantProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id])

  leaseId     String
  lease       Lease     @relation(fields: [leaseId], references: [id])

  phone       String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum LedgerEntryType {
  CHARGE
  PAYMENT
  ADJUSTMENT
}

model LedgerEntry {
  id              String          @id @default(cuid())
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id])

  leaseId         String
  lease           Lease           @relation(fields: [leaseId], references: [id])

  type            LedgerEntryType
  amountCents     Int
  description     String
  effectiveDate   DateTime

  paymentId       String?         @unique
  payment         Payment?        @relation(fields: [paymentId], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([organizationId, leaseId])
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

model Payment {
  id                     String        @id @default(cuid())
  organizationId         String
  organization           Organization  @relation(fields: [organizationId], references: [id])

  leaseId                String
  lease                  Lease         @relation(fields: [leaseId], references: [id])

  amountCents            Int
  status                 PaymentStatus @default(PENDING)
  method                 String

  stripePaymentIntentId  String        @unique

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  ledgerEntry            LedgerEntry?

  @@index([organizationId, leaseId])
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CANCELED
}

model WorkOrder {
  id              String          @id @default(cuid())
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id])

  unitId          String
  unit            Unit            @relation(fields: [unitId], references: [id])

  title           String
  description     String
  status          WorkOrderStatus @default(OPEN)

  tenantId        String?
  tenant          TenantProfile?  @relation(fields: [tenantId], references: [id])

  assigneeId      String?
  assignee        User?           @relation("WorkOrderAssignee", fields: [assigneeId], references: [id])

  comments        WorkOrderComment[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([organizationId, unitId])
}

model WorkOrderComment {
  id          String   @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])

  authorId    String
  author      User     @relation("WorkOrderCommentAuthor", fields: [authorId], references: [id])

  body        String

  createdAt   DateTime @default(now())
}

model Document {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  s3Key           String
  fileName        String
  contentType     String
  sizeBytes       Int

  entityType      String
  entityId        String

  createdAt       DateTime      @default(now())

  @@index([organizationId, entityType, entityId])
}

model AuditLog {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  actorId         String?
  actor           User?         @relation("AuditActor", fields: [actorId], references: [id])

  action          String
  metadata        Json?

  createdAt       DateTime      @default(now())

  @@index([organizationId, createdAt])
}

model Subscription {
  id                   String        @id @default(cuid())
  organizationId       String        @unique
  organization         Organization  @relation(fields: [organizationId], references: [id])

  stripeSubscriptionId String        @unique
  status               String
  pricePerUnitCents    Int

  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}
